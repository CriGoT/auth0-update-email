module.exports=function(e){function n(r){if(t[r])return t[r].exports;var a=t[r]={exports:{},id:r,loaded:!1};return e[r].call(a.exports,a,a.exports,n),a.loaded=!0,a.exports}var t={};return n.m=e,n.c=t,n.p="",n(0)}([function(e,n,t){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}var a=t(11),i=r(a),s=t(5),o=r(s);e.exports=function(e,n,t){return i["default"].fromExpress((0,o["default"])(e.secrets))(e,n,t)}},function(e,n){e.exports=require("boom")},function(e,n){e.exports=require("express")},function(e,n){e.exports=require("request")},function(e,n){e.exports=require("url")},function(e,n,t){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(n,"__esModule",{value:!0}),n["default"]=function(e){var n=(0,i["default"])(),t=(0,o["default"])(e);return n.use("/",t),n};var a=t(2),i=r(a),s=t(6),o=r(s),l=t(8);r(l)},function(e,n,t){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function a(e){var n=function(n,t,r){try{var a=new m.ManagementClient({token:e.AUTH0_MANAGEMENT_TOKEN,domain:e.AUTH0_DOMAIN});n.auth0Client=a}catch(i){return console.log("Auth0 client not available"),r(i)}return r()},t=(0,c["default"])({secret:new Buffer(e.AUTH0_CLIENT_SECRET,"base64"),audience:e.AUTH0_CLIENT_ID}),r=s["default"].Router();r.get("/isavailable",function(n,t){return n.query.m?(console.log("Checking if e-mail "+n.query.m+" is being used"),void n.auth0Client.users.getAll({per_page:1,include_fields:!0,search_engine:"v2",fields:"email",q:'identities.connection:"'+e.AUTH0_CONNECTION+'" AND email:"'+n.query.m+'"'}).then(function(e){var r=!e.some(function(e){return e.email.toUpperCase()===n.query.m.toUpperCase()});console.log("E-mail "+n.query.m+" is "+(r?"not ":"")+" being used"),t.status(200).json(r)})["catch"](function(e){console.log(e),t.status(500).json({name:"InternalError",code:"management_api_error",description:"The Managemente API returned an error",statusCode:500})})):t.status(400).json({name:"BadRequestError",code:"mail_required",description:"You must provide a mail to validate",statusCode:400})}),r.patch("/me",function(e,n){console.log(e.body),e.body&&e.body.email?(console.log("Updating user "+e.user.sub+" with email "+e.body.email),e.auth0Client.users.update({id:e.user.sub},{email:e.body.email}).then(function(t){console.log("User "+e.user.sub+" updated!"),e.auth0Client.jobs.verifyEmail({user_id:e.user.sub}).then(function(t){console.log("Verification for user "+e.user.sub+" requested!"),n.status(201).json({status:"completed",message:"Your E-mail address has been updated you will shortly receive a message to verify it."})})["catch"](function(e){console.log(e),n.status(201).json({status:"pending",message:"Your E-mail address has been updated but the message to verify your new address was not sent."})})})["catch"](function(e){console.log(e),n.status(500).json({name:"InternalError",code:"management_api_error",description:"The Managemente API returned an error while updating the user",statusCode:500})})):n.status(400).json({name:"BadRequestError",code:"mail_required",description:"You must provide a mail to update the user info",statusCode:400})});var a=s["default"].Router();return a.use("/api",t,n,h["default"].json(),r),a.get("/",function(n,t){t.header("Content-Type","text/html"),t.status(200).send((0,l["default"])({baseUrl:f["default"].getBaseUrl(n),config:e}))}),a}Object.defineProperty(n,"__esModule",{value:!0}),n["default"]=a;var i=t(2),s=r(i),o=t(9),l=r(o),u=t(14),c=r(u),d=t(7),f=r(d),p=t(13),h=r(p),m=t(12)},function(e,n,t){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function a(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),s=t(4),o=r(s),l=function(){function e(){a(this,e)}return i(e,null,[{key:"getBaseUrl",value:function(e){var n=o["default"].parse(e.originalUrl).pathname.replace(e.path,""),t="https";return"development"===(process.env.NODE_ENV||"development")&&(t=e.protocol),o["default"].format({protocol:t,host:e.get("host"),pathname:n})}}]),e}();n["default"]=l},function(e,n,t){function r(e,n){var t="string"==typeof e&&e===n||e instanceof RegExp&&!!e.exec(n);return e instanceof RegExp&&(e.lastIndex=0),e&&e.url&&(t=r(e.url,n)),t}function a(e,n){return e?(e=Array.isArray(e)?e:[e],!!~e.indexOf(n)):!0}var i=t(4);e.exports=function(e){var n=this,t="function"==typeof e?{custom:e}:e;return t.useOriginalUrl="undefined"==typeof t.useOriginalUrl?!0:t.useOriginalUrl,function(e,s,o){var l=i.parse((t.useOriginalUrl?e.originalUrl:e.url)||e.url||"",!0),u=!1;t.custom&&(u=u||t.custom(e));var c=!t.path||Array.isArray(t.path)?t.path:[t.path];c&&(u=u||c.some(function(n){return r(n,l.pathname)&&a(n.methods,e.method)}));var d=!t.ext||Array.isArray(t.ext)?t.ext:[t.ext];d&&(u=u||d.some(function(e){return l.pathname.substr(-1*e.length)===e}));var f=!t.method||Array.isArray(t.method)?t.method:[t.method];return f&&(u=u||!!~f.indexOf(e.method)),u?o():void n(e,s,o)}}},function(e,n,t){var r=t(10);e.exports=function(e){var n,t=[],a=e||{};return function(e,a,i){t.push('<!DOCTYPE html><html><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="description"'+r.attr("content",""+i,!0,!0)+'><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="shortcut icon" href="https://cdn.auth0.com/styleguide/2.0.1/lib/logos/img/favicon.png"><link rel="apple-touch-icon" href="apple-touch-icon.png"><link rel="stylesheet" type="text/css" href="https://cdn.auth0.com/styleguide/latest/index.css"><script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script><script type="text/javascript" src="https://fb.me/react-0.14.0.min.js"></script><script type="text/javascript" src="https://fb.me/react-dom-0.14.0.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script><script type="text/javascript" src="https://cdn.auth0.com/js/jwt-decode-1.4.0.min.js"></script><script type="text/javascript" src="https://cdn.auth0.com/js/navbar-1.0.1.min.js"></script><script type="text/javascript" src="https://cdn.auth0.com/auth0/auth0-2.1.0.min.js"></script><script type="text/javascript" src="https://cdn.auth0.com/js/lock-9.0.min.js"></script></head><body><header class="dashboard-header"><nav role="navigation" class="navbar navbar-default"><div class="container"><div class="navbar-header"><i aria-hidden="true" style="font-size:40px" class="icon-budicon-781 icon navbar-brand"></i><span style="font-size:30px" class="navbar-link">E-Mail Update</span></div></div></nav></header><div class="container root-container"><div class="row"><div id="content" class="wrapper col-xs-10"></div></div></div><script type="text/babel">var Home = React.createClass({\n  showLock: function() {\n    this.props.lock.showSignin({closable:false,rememberLastLogin:false,connections:[this.props.connection]});\n  },\n\n  componentDidMount:function() {\n    this.showLock();\n  },\n\n  render: function() {\n    return (\n      <div className="col-xs-6 col-xs-offset-3">\n        <p>To change your E-mail address you must authenticate.</p>\n        <a onClick={this.showLock} className="btn btn-primary btn-lg btn-login btn-block ">Sign In</a>\n      </div>\n    );\n  }\n});\nvar timer;\nvar LoggedIn = React.createClass({\n  getInitialState: function() {\n    return {\n      profile: null,\n      new_mail: null,\n      is_valid: false,\n      is_available: false,\n      changed: false,\n      working: false,\n      result: null,\n      error: null\n    }\n  },\n\n  updateEmail: function() {\n    var data = JSON.stringify({email:this.state.new_mail});\n    this.setState({\n      profile: this.state.profile,\n      new_mail: this.state.new_mail,\n      is_valid: true,\n      is_available: true,\n      changed: true,\n      working: true,\n      result: null,\n      error: null});\n    $.ajax({\n      method: \'PATCH\',\n      url: this.props.apiUrl + \'/me\',\n      data: data,\n      dataType: \'json\',\n      contentType: \'application/json\',\n      cache: false})\n    .then( result=>{\n      this.setState({\n        profile: this.state.profile,\n        new_mail: this.state.new_mail,\n        is_valid: true,\n        is_available: true,\n        changed: true,\n        working: true,\n        result: result.message,\n        error: null});\n      window.location.replace(\'#\');\n    },err =>{\n      console.log(err);\n      this.setState({\n        profile: this.state.profile,\n        new_mail: this.state.new_mail,\n        is_valid: true,\n        is_available: true,\n        changed: true,\n        working: true,\n        result: null,\n        error: err.description});\n      window.location.replace(\'#\');\n    });\n\n  },\n\n  checkAvailability: function()\n  {\n     var state = this.state;\n     state.working=true;\n     if (state.is_valid && state.changed){\n      this.setState(state);\n      $.ajax({\n        method: \'GET\',\n        url: this.props.apiUrl + \'/isavailable\',\n        data: {m:state.new_mail},\n        dataType: \'json\',\n        cache: false})\n      .then( result=>{\n        if (state.new_mail===this.state.new_mail)\n          this.setState({\n            profile: this.state.profile,\n            new_mail: state.new_mail,\n            is_valid: true,\n            is_available: result,\n            changed: true,\n            working: false,\n            result: null,\n            error: null});\n      },err =>{\n        console.log(err);\n        this.setState({\n          profile: this.state.profile,\n          new_mail:event.target.value,\n          is_valid: true,\n          is_available: false,\n          changed: true,\n          working: false,\n          result: null,\n          error: null});\n      });\n     }\n  },\n\n  onMailChange: function(event) {\n    window.clearTimeout(timer);\n    var regExp = /^((([a-z]|\\d|[!#\\$%&\'\\*\\+\\-\\/=\\?\\^_`{\\|}~]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])+(\\.([a-z]|\\d|[!#\\$%&\'\\*\\+\\-\\/=\\?\\^_`{\\|}~]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])+)*)|((\\x22)((((\\x20|\\x09)*(\\x0d\\x0a))?(\\x20|\\x09)+)?(([\\x01-\\x08\\x0b\\x0c\\x0e-\\x1f\\x7f]|\\x21|[\\x23-\\x5b]|[\\x5d-\\x7e]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(\\\\([\\x01-\\x09\\x0b\\x0c\\x0d-\\x7f]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF]))))*(((\\x20|\\x09)*(\\x0d\\x0a))?(\\x20|\\x09)+)?(\\x22)))@((([a-z]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(([a-z]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])([a-z]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])*([a-z]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])))\\.)+(([a-z]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(([a-z]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])([a-z]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])*([a-z]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])))$/i;\n\n    if (!event.target.value)\n    {\n      this.setState({\n        profile: this.state.profile,\n        new_mail: null,\n        is_valid: false,\n        is_available: false,\n        changed: false,\n        working: false,\n        result: null,\n        error: null});\n      return;\n    }\n\n    var valid = regExp.test(event.target.value);\n    var changed = event.target.value !== this.state.profile.email;\n\n    this.setState({\n        profile: this.state.profile,\n        new_mail: event.target.value,\n        is_valid: valid,\n        is_available: false,\n        changed: changed,\n        working: valid && changed,\n        result: null,\n        error: null});\n\n    if (valid && changed) {\n      timer = window.setTimeout(this.checkAvailability,350);\n    }\n  },\n\n  componentDidMount: function() {\n    this.props.lock.getProfile(this.props.idToken, function (err, profile) {\n      if (err) {\n        console.log("Error loading the Profile", err);\n        alert("Error loading the Profile");\n      }\n      this.setState({profile: profile, new_mail:profile.email, is_valid:false, is_available:false, changed:false, working: false});\n    }.bind(this));\n  },\n\n  renderForm : function() {\n    return (\n      <form className="form-horizontal">\n        <div className="form-group">\n          <label className="col-xs-3 control-label">Current E-Mail</label>\n          <div className="col-xs-6">\n            <input type="text" required readOnly className="form-control" value={this.state.profile.email} />\n          </div>\n        </div>\n        <div className="form-group">\n          <label className="col-xs-3 control-label">New E-Mail</label>\n          <div className="col-xs-6">\n            <input type="text" onChange={this.onMailChange} className="form-control" readOnly={this.state.result || this.state.error || (this.state.is_available && this.state.working)} value={this.state.new_mail} />\n          </div>\n        </div>\n      </form>);\n  },\n\n  renderButton: function() {\n    if (this.state.result)\n      return(\n        <div className="alert alert-success">\n          <p>{this.state.result}</p>\n          <strong>For your security close the browser</strong>\n        </div>\n      );\n\n    if (this.state.error)\n    {\n      return(\n        <div className="alert alert-success">\n        <p>{this.state.error}</p>\n        <strong>For your security close the browser</strong>\n        </div>\n      );\n    }\n\n\n    if (this.state.changed)\n       if (this.state.is_valid)\n         if (this.state.working)\n           return (\n              <div className="spinner spinner-md is-auth0 center-block" >\n                <div className="circle"></div>\n              </div>\n            );\n         else\n           if (this.state.is_available)\n             return (\n              <button onClick={this.updateEmail} className="btn btn-lg btn-primary center-block"><span className="btn-icon icon-budicon-781"> </span>Update E-mail</button>\n             );\n           else\n             return (\n              <button className="btn btn-lg btn-danger center-block"><span className="btn-icon icon-budicon-782"> </span>E-mail address already in use</button>\n             );\n       else\n         return (\n            <button className="btn btn-lg btn-warning center-block"><span className="btn-icon icon-budicon-780"> </span>Invalid E-mail address</button>\n         );\n    else\n       return (\n          <button className="btn btn-lg btn-primary center-block" disabled><span className="btn-icon icon-budicon-781"> </span>Update E-mail</button>\n       );\n  },\n\n  render: function() {\n    if (this.state.profile) {\n      return (\n        <div>\n          <h2>Welcome {this.state.profile.name || this.state.profile.nickname}</h2>\n          {this.renderForm()}\n          {this.renderButton()}\n        </div>);\n    } else {\n      return (\n          <div className="alert alert-danger">There was an error retrieving your information. Please, try again later or contact your administrator.</div>\n        );\n    }\n  }\n});\nvar App = React.createClass({\n    componentWillMount: function() {\n      this.createLock();\n      this.setupAjax();\n      this.setState({idToken: this.getIdToken(),submitted:false})\n    },\n    createLock: function() {\n      this.lock = new Auth0Lock(this.props.clientId, this.props.domain);\n    },\n\n    setupAjax: function() {\n      var id_token = this.getIdToken();\n      if (id_token)\n      {\n        $.ajaxSetup({\n          \'beforeSend\': function(xhr) {\n              xhr.setRequestHeader(\'Authorization\',\n                    \'Bearer \' + id_token);\n          }\n        });\n      }\n    },\n    getIdToken: function() {\n      var idToken;\n      var authHash = this.lock.parseHash(window.location.hash);\n      if (authHash) {\n        if (authHash.id_token) {\n          idToken = authHash.id_token;\n        }\n        if (authHash.error) {\n          console.log("Error signing in", authHash);\n        }\n      }\n      return idToken;\n    },\n    render: function() {\n      if (this.state.idToken) {\n        return (<LoggedIn lock={this.lock} idToken={this.state.idToken} {...this.props} />);\n      } else {\n        return (<Home lock={this.lock} {...this.props} />);\n      }\n    }\n  });\nvar AUTH0_DOMAIN=\''+r.escape(null==(n=a.AUTH0_DOMAIN)?"":n)+"';\nvar AUTH0_CLIENT_ID='"+r.escape(null==(n=a.AUTH0_CLIENT_ID)?"":n)+"';\nvar apiUrl = '"+r.escape(null==(n=e)?"":n)+"/api';\nvar AUTH0_CONNECTION = '"+r.escape(null==(n=a.AUTH0_CONNECTION)?"":n)+"'\nReactDOM.render(\n  <App clientId={AUTH0_CLIENT_ID} domain={AUTH0_DOMAIN} apiUrl={apiUrl} connection={AUTH0_CONNECTION}/>,\n  document.getElementById('content')\n);</script></body></html>")}.call(this,"baseUrl"in a?a.baseUrl:"undefined"!=typeof baseUrl?baseUrl:void 0,"config"in a?a.config:"undefined"!=typeof config?config:void 0,"description"in a?a.description:"undefined"!=typeof description?description:void 0),t.join("")}},function(e,n,t){"use strict";function r(e){return null!=e&&""!==e}function a(e){return(Array.isArray(e)?e.map(a):e&&"object"==typeof e?Object.keys(e).filter(function(n){return e[n]}):[e]).filter(r).join(" ")}n.merge=function i(e,n){if(1===arguments.length){for(var t=e[0],a=1;a<e.length;a++)t=i(t,e[a]);return t}var s=e["class"],o=n["class"];(s||o)&&(s=s||[],o=o||[],Array.isArray(s)||(s=[s]),Array.isArray(o)||(o=[o]),e["class"]=s.concat(o).filter(r));for(var l in n)"class"!=l&&(e[l]=n[l]);return e},n.joinClasses=a,n.cls=function(e,t){for(var r=[],i=0;i<e.length;i++)t&&t[i]?r.push(n.escape(a([e[i]]))):r.push(a(e[i]));var s=a(r);return s.length?' class="'+s+'"':""},n.style=function(e){return e&&"object"==typeof e?Object.keys(e).map(function(n){return n+":"+e[n]}).join(";"):e},n.attr=function(e,t,r,a){return"style"===e&&(t=n.style(t)),"boolean"==typeof t||null==t?t?" "+(a?e:e+'="'+e+'"'):"":0==e.indexOf("data")&&"string"!=typeof t?(-1!==JSON.stringify(t).indexOf("&")&&console.warn("Since Jade 2.0.0, ampersands (`&`) in data attributes will be escaped to `&amp;`"),t&&"function"==typeof t.toISOString&&console.warn("Jade will eliminate the double quotes around dates in ISO form after 2.0.0")," "+e+"='"+JSON.stringify(t).replace(/'/g,"&apos;")+"'"):r?(t&&"function"==typeof t.toISOString&&console.warn("Jade will stringify dates in ISO form after 2.0.0")," "+e+'="'+n.escape(t)+'"'):(t&&"function"==typeof t.toISOString&&console.warn("Jade will stringify dates in ISO form after 2.0.0")," "+e+'="'+t+'"')},n.attrs=function(e,t){var r=[],i=Object.keys(e);if(i.length)for(var s=0;s<i.length;++s){var o=i[s],l=e[o];"class"==o?(l=a(l))&&r.push(" "+o+'="'+l+'"'):r.push(n.attr(o,l,!1,t))}return r.join("")},n.escape=function(e){var n=String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");return n===""+e?e:n},n.rethrow=function s(e,n,r,a){if(!(e instanceof Error))throw e;if(!("undefined"==typeof window&&n||a))throw e.message+=" on line "+r,e;try{a=a||t(15).readFileSync(n,"utf8")}catch(i){s(e,null,r)}var o=3,l=a.split("\n"),u=Math.max(r-o,0),c=Math.min(l.length,r+o),o=l.slice(u,c).map(function(e,n){var t=n+u+1;return(t==r?"  > ":"    ")+t+"| "+e}).join("\n");throw e.path=n,e.message=(n||"Jade")+":"+r+"\n"+o+"\n\n"+e.message,e},n.DebugItem=function(e,n){this.lineno=e,this.filename=n}},function(e,n,t){function r(e){return function(n,t,r){var a=s(t.x_wt.jtn);return t.originalUrl=t.url,t.url=t.url.replace(a,"/"),t.webtaskContext=o(n),e(t,r)}}function a(e){var n;return e.ext("onRequest",function(e,t){var r=s(e.x_wt.jtn);e.setUrl(e.url.replace(r,"/")),e.webtaskContext=n}),function(t,r,a){var i=e._dispatch();n=o(t),i(r,a)}}function i(e){return function(n,t,r){var a=s(t.x_wt.jtn);return t.originalUrl=t.url,t.url=t.url.replace(a,"/"),t.webtaskContext=o(n),e.emit("request",t,r)}}function s(e){var n="^/api/run/[^/]+/",t="(?:[^/?#]*/?)?";return new RegExp(n+(e?t:""))}function o(e){function n(e,n,r){var a=t(1);"function"==typeof n&&(r=n,n={}),r(a.preconditionFailed("Storage is not available in this context"))}function r(n,r,a){var i=t(1),s=t(3);"function"==typeof r&&(a=r,r={}),s({uri:e.secrets.EXT_STORAGE_URL,method:"GET",headers:r.headers||{},qs:{path:n},json:!0},function(e,n,t){return e?a(i.wrap(e,502)):404===n.statusCode&&Object.hasOwnProperty.call(r,"defaultValue")?a(null,r.defaultValue):n.statusCode>=400?a(i.create(n.statusCode,t&&t.message)):void a(null,t)})}function a(e,n,r,a){var i=t(1);"function"==typeof r&&(a=r,r={}),a(i.preconditionFailed("Storage is not available in this context"))}function i(n,r,a,i){var s=t(1),o=t(3);"function"==typeof a&&(i=a,a={}),o({uri:e.secrets.EXT_STORAGE_URL,method:"PUT",headers:a.headers||{},qs:{path:n},body:r},function(e,n,t){return e?i(s.wrap(e,502)):n.statusCode>=400?i(s.create(n.statusCode,t&&t.message)):void i(null)})}return e.read=e.secrets.EXT_STORAGE_URL?r:n,e.write=e.secrets.EXT_STORAGE_URL?i:a,e}n.fromConnect=n.fromExpress=r,n.fromHapi=a,n.fromServer=n.fromRestify=i},function(e,n){e.exports=require("auth0@2.1.0")},function(e,n){e.exports=require("body-parser")},function(e,n){e.exports=require("express-jwt")},function(e,n){e.exports=require("fs")}]);